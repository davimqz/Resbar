// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Usuários do sistema (com autenticação)
model User {
  id          String    @id @default(cuid())
  email       String    @unique
  name        String
  birthdate   DateTime?
  gender      Gender?
  customGender String?  // Usado quando gender = OTHER
  role        UserRole  @default(STANDARD)
  googleId    String?   @unique
  avatar      String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@map("users")
}

// Garçons do estabelecimento
model Waiter {
  id             String    @id @default(cuid())
  name           String
  active         Boolean   @default(true)
  onBreak        Boolean   @default(false)
  breakStartedAt DateTime?
  clockedInAt    DateTime?
  clockedOutAt   DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  
  tables         Table[]
  tabHistory     TabWaiterHistory[]
  
  @@map("waiters")
}

// Mesas do 
model Table {
  id              String      @id @default(cuid())
  number          Int         @unique
  location        String?     // Localização física (ex: "Área externa", "Salão principal")
  capacity        Int         @default(4)
  status          TableStatus @default(AVAILABLE)
  waiterId        String?
  allTabsPaidAt   DateTime?   // Quando todas as comandas foram pagas
  releasedAt      DateTime?   // Quando o garçom liberou a mesa
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  waiter          Waiter?     @relation(fields: [waiterId], references: [id])
  tabs            Tab[]
  
  @@map("tables")
}

// Pessoas sentadas em uma mesa
model Person {
  id        String   @id @default(cuid())
  name      String
  tabId     String   @unique // Relacionamento 1:1 - cada pessoa tem sua própria comanda
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  tab       Tab      @relation(fields: [tabId], references: [id], onDelete: Cascade)
  
  @@map("persons")
}

// Comanda individual (uma por pessoa)
model Tab {
  id                        String         @id @default(cuid())
  tableId                   String?        // Opcional para comandas de balcão
  type                      TabType        @default(TABLE)
  total                     Float          @default(0)
  status                    TabStatus      @default(OPEN)
  paymentMethod             PaymentMethod?
  paidAmount                Float?         // Valor pago pelo cliente
  changeAmount              Float?         // Troco (se pagamento em dinheiro)
  serviceChargeIncluded     Boolean        @default(true)
  serviceChargePaidSeparately Boolean      @default(false)
  serviceChargeAmount       Float?
  isUnifiedTab              Boolean        @default(false) // Marca se esta comanda recebeu transferências (comanda única)
  unifiedTabPersonCount     Int?           // Quantas pessoas tiveram comandas ativas antes da unificação
  customerSeatedAt          DateTime?      // Horário que o cliente sentou
  requestedBillAt           DateTime?      // Horário que pediu a conta
  paidAt                    DateTime?      // Horário que pagou
  createdAt                 DateTime       @default(now())
  updatedAt                 DateTime       @updatedAt
  closedAt                  DateTime?
  
  table                     Table?         @relation(fields: [tableId], references: [id], onDelete: Cascade)
  person                    Person?
  orders                    Order[]
  waiterHistory             TabWaiterHistory[]
  cancellationRequests      TabCancellationRequest[]
  
  @@map("tabs")
}

// Pedidos feitos em uma comanda
model Order {
  id                   String      @id @default(cuid())
  tabId                String
  menuItemId           String
  quantity             Int         @default(1)
  unitPrice            Float       // Preço unitário no momento do pedido
  totalPrice           Float       // quantity * unitPrice
  status               OrderStatus @default(PENDING)
  notes                String?     // Observações do pedido (ex: "Sem cebola")
  serviceChargeIncluded Boolean    @default(true)
  sentToKitchenAt      DateTime?   // Horário enviado para cozinha
  startedPreparingAt   DateTime?   // Horário que começou preparo
  readyAt              DateTime?   // Horário que ficou pronto
  deliveredAt          DateTime?   // Horário que foi entregue
  createdAt            DateTime    @default(now())
  updatedAt            DateTime    @updatedAt
  
  tab                  Tab         @relation(fields: [tabId], references: [id], onDelete: Cascade)
  menuItem             MenuItem    @relation(fields: [menuItemId], references: [id])
  returnRequests       ReturnRequest[]
  
  @@map("orders")
}

// Solicitações de devolução de pedidos
model ReturnRequest {
  id           String              @id @default(cuid())
  orderId      String
  category     ReturnCategory
  subcategory  String              // Subcategoria específica (será validada no backend)
  description  String?             // Descrição detalhada do problema
  sourceType   ReturnSourceType?   // Normalized source: COMANDA or MESA
  sourceId     String?             // Id of comanda or number of mesa
  imageUrl     String?             // URL da imagem anexada
  status       ReturnRequestStatus @default(PENDING)
  createdById  String              // Usuário que criou a solicitação
  resolvedById String?             // Usuário que resolveu a solicitação
  resolvedAt   DateTime?           // Quando foi resolvida
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  
  order        Order               @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  @@map("return_requests")
}

// Solicitações de cancelamento de comandas
model TabCancellationRequest {
  id                String                        @id @default(cuid())
  tabId             String
  category          TabCancellationCategory
  reason            String?                       // Motivo detalhado
  requestedByUserId String                        // Usuário que solicitou
  approvedByUserId  String?                       // Admin que aprovou/rejeitou
  status            TabCancellationRequestStatus  @default(PENDING)
  resolvedAt        DateTime?                     // Quando foi resolvida
  createdAt         DateTime                      @default(now())
  updatedAt         DateTime                      @updatedAt
  
  tab               Tab                           @relation(fields: [tabId], references: [id], onDelete: Cascade)
  
  @@map("tab_cancellation_requests")
}

// Itens do cardápio
model MenuItem {
  id                  String         @id @default(cuid())
  name                String
  description         String?
  detailedDescription String?        // Descrição mais completa do prato
  price               Float
  category            MenuCategory
  available           Boolean        @default(true)
  imageUrl            String?
  allergens           String[]       // Array de códigos de alergias (ex: ['GLUTEN', 'DAIRY'])
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt
  
  orders              Order[]
  
  @@map("menu_items")
}

// Itens de estoque (mockup para futura implementação)
model InventoryItem {
  id          String   @id @default(cuid())
  name        String
  quantity    Float    @default(0)
  unit        String   // ex: "kg", "L", "unidades"
  minStock    Float    @default(0)
  category    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("inventory_items")
}

// Histórico de garçons atendendo uma comanda
model TabWaiterHistory {
  id         String    @id @default(cuid())
  tabId      String
  waiterId   String
  assignedAt DateTime  @default(now())
  removedAt  DateTime?
  
  tab        Tab       @relation(fields: [tabId], references: [id], onDelete: Cascade)
  waiter     Waiter    @relation(fields: [waiterId], references: [id])
  
  @@index([tabId])
  @@index([waiterId])
  @@map("tab_waiter_history")
}

// Enums
enum TableStatus {
  AVAILABLE
  OCCUPIED
  RESERVED
  PAID_PENDING_RELEASE // Mesa paga mas aguardando liberação pelo garçom
}

enum UserRole {
  STANDARD // Cliente padrão
  WAITER   // Garçom
  KITCHEN  // Cozinha
  ADMIN    // Administrador
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum TabStatus {
  OPEN
  CLOSED
  CANCELLED
}

enum TabType {
  TABLE   // Mesa
  COUNTER // Balcão
}

enum OrderStatus {
  PENDING     // Pedido registrado, aguardando preparo
  PREPARING   // Em preparo na cozinha
  READY       // Pronto para servir
  DELIVERED   // Entregue ao cliente
}

enum MenuCategory {
  APPETIZER
  MAIN_COURSE
  SIDE_DISH
  DESSERT
  BEVERAGE
  ALCOHOLIC_BEVERAGE
}

enum PaymentMethod {
  CASH
  CREDIT_CARD
  DEBIT_CARD
  PIX
}

enum ReturnCategory {
  PREPARO           // Problemas com o preparo do prato
  OPERACIONAL       // Erros operacionais
  TEMPO_ESPERA      // Problemas com tempo de espera
  QUALIDADE         // Problemas com qualidade
  SEGURANCA         // Problemas de segurança alimentar
  COMERCIAL         // Questões comerciais
}

enum ReturnRequestStatus {
  PENDING     // Aguardando análise
  APPROVED    // Aprovada
  REJECTED    // Rejeitada
}

// Fonte normalizada da solicitação
enum ReturnSourceType {
  COMANDA
  MESA
}

// Categoria de cancelamento de comanda
enum TabCancellationCategory {
  CLIENTE_DESISTIU        // Cliente desistiu/saiu sem consumir
  ERRO_OPERACIONAL        // Erro na abertura da comanda
  MESA_INCORRETA          // Comanda aberta na mesa errada
  DUPLICADA               // Comanda duplicada
  CLIENTE_INSATISFEITO    // Cliente insatisfeito com atendimento
  OUTROS                  // Outros motivos
}

// Status da solicitação de cancelamento
enum TabCancellationRequestStatus {
  PENDING     // Aguardando aprovação do admin
  APPROVED    // Aprovada pelo admin
  REJECTED    // Rejeitada pelo admin
}
